# ATDD 소개
## 페어프로그래밍
- 하나의 컴퓨터에서 두 사람의 프로그래머가 작업하는 방법
- 드라이버 : 코드 작성하는 사람
- 네비게이터 : 옆에서 조언
- 즉각적 피드백

## 자동화된 테스트
- 테스트 코드들이 나에게 피드백을 줌

## 인수테스트
- 계획한 시나리오대로 기능이 잘 동작하는지 검증하는 테스트
    - 시나리오 레벨로 검증
- 배포없이 검증하는 기능을 확인
- 새로운 팀의 도메인과 비즈니스 플로우 파악에 큰 도움이 됨
- 테스트를 하니씩 실행하며 기능들의 종류와 프로세스를 익힐 수 있음

## 테스트 주도 개발
- 테스트 코드는 설계의 역할도 한다
- 설계가 바뀌면 테스트 코드도 바뀌어야 한다
- 테스트 코드를 작성함으로써 막연한 구현보다는 작은 단위로 구현해갈수 있다
- TDD 의 아쉬운 부분
    - 어떻게 시작하고 어디까지 구현해야 할 지 잘 모르겠음
    - 작은 단위를 검증하는 테스트를 작성하였지만 아무데서도 호출하지 않거나 시스템의 나머지 부분과 통합할 수 없어서 재작성해야 하는 경우가 발생
- 인수 테스트를 통해 단위테스트만 하는 TDD 보다 막연한 느낌을 덜 받을 수 있다

## ATDD 개발 cycle
`요구사항 → 문서화 → 인수테스트 → TDD → API 개발 → 테스트 리펙터링`

## 미션 - 지하철 노선도 애플리케이션
요구사항에 따라 단계별로 인수 테스트와 API 구현

## ATDD, TDD, BDD
- 명세의 관점에서
    - ATDD : 인수테스트
    - TDD : 명세, 스팩
    - BDD : 행위
- BDD 는 작은 단위에서도 가능
- ATDD 는 명확히 인수 테스트를 기반으로 시나리오를 검증

## ATDD
### 인수 테스트
- 계약의 요구사항이 충족되는지 확인하기 위해 수행되는 테스트
- 소프트웨어 개발 발벙론, 특히 xp 에서 사용되는 용어로서, 구현 단계에서 소프트웨어 개발 팀이 `사용자 스토리를 기능적으로 테스트`하는 것을 의미함
- Black Box 테스트 : 내부 구조나 작동과 연관이 없는 테스트
- 너무 기술적으로 정의하면, 클라이언트가 읽기 힘듬 ⇒ 최대한 기술적인 맥락이 아닌 알기 쉬운 형태로 작성해야 함
- 공통의 이해를 돕기위한 테스트 ⇒ 인수를 하기 위한 테스트
- `사용자스토리 → 인수조건(문서) → 인수테스트 → 소프트웨어 → 비즈니스 밸류`
- 리팩토링 방법
    - 인수테스트를 작성하여 기존에 구현된 기능 보호
    - 파악이 가능한 부분부터 단위 테스트를 만들어 기능 검증
    - 인수 테스트의 보호속에서 리팩토링 하자

## 인수 테스트와 도구
### 인수 테스트 만들기
- @SpringBootTest 를 통해 테스트를 위한 서버 로드
- RestAssured : 클라이언트 객체 , MockMvc 나 WebMvcClient 와 비슷함

### 구현
RestAssured 에서는 given(사전조건), when(요청), then(응답) 을 지원

### @SpringBootTest
- Spring Application 에서 사용하는 Application Context 를 테스트에서 사용할 수 있게 해줌
- 모든 부분을 사용하고 싶지 않을 경우 slice 해서 쓸 수 있음

### Mock
- MockMvc
    - @SpringBootTest 의 webEnvironment.MOCK 과 함께 사용가능하며 mocking 된 web environment(ex tomcat) 환경에서 테스트
    - 실제 웹 환경이 아니라 Spring 의 Presentation layer 에서 path 를 찾아 매칭된 컨트롤러를 호출한다
    - 실제 요청을 보내는 것이 아니라 transactional 등의 설정이 가능하다
- WebTestClient
    - @SpringBootTest 의 webEnvironment.RANDOM_PORT 나 DEFINED_PORT 와 함께 사용, netty 를 기본으로 사용
    - 웹플럭스 환경에 적합한 테스트 객체
- RestAssured
    - 실제 web environment(Apache Tomcat)을 사용하여 테스트

### JsonPath
- java dsl 로 json document 를 읽도록 도와주는 라이브러리

### @DirtiesContext
- 효과적인 테스트 수행을 위해 스프링에서 context caching 기능 지원하는 데 캐시 기능을 사용하지 않게 하는 애노테이션
- 매번 context 를 새로 구성하다보니 시간이 많이 걸림
- 완벽한 격리이지만 추천하지 않음 ⇒ 시간이 너무 오래 걸림

### 데이터베이스 초기화
- 테스트를 격리시키기 위해 database 를 초기화 하는 유틸성 클래스를 만들어 사용한다

## API 요청
- 클라이언트가 요청할 때, 원하는 응답값에 따라서도 호출되는 메서드가 달라질 수 있다

```java
// produces 로 어떤 값을 응답하는 지 지정
@GetMapping(value = "/stations", produces = MediaType.APPLICATION_JSON_VALUE)
```

## 인수조건을 테스트로 옮기기
- Feature 기준으로 인수 테스트 클래스를 나눌 수 있음
- Senario 기준으로 인수 테스트 메서드를 작성할 수 있음
- 하나의 Feature 내부에 있는 Senario 에 같은 테스트 픽츠쳐를 공유하기

### 간단한 성공 케이스 우선 작성
- 동작 가능한 가장 간단한 성공 케이스로 시작
- 테스트가 동작하면 실제 구조에 관해 더 좋은 생각이 떠오를 수 있음
- 그 과정에서 발생 가능한 실패를 처리하는 것과 성공 케이스 사이에서 우선 순위를 가늠

### 실패하는 테스트 지켜보기
- 로그를 보고 실패하는 원인을 파악

### Given/When/Then
- When → Then → Given 순서로 작성하기
- 무엇을 하고자 하는가? → 어떤 결과를 얻을 것인가? → 어떤 조건을 줄 것인가?

### 중복 제거 방법
- 메서드 분리
- CRUD 추상화
- Cucumber 나 JBehave 와 같은 BDD 도구 사용
- 메서드 네이밍 룰 : 도메인_행위_스텝 ⇒ 이런형태가 좋은 거 같음